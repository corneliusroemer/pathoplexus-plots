<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Pathoplexus Organism Submissions (2024‑08 – 2025‑06)</title>
  <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f9f9f9;
      color: #111
    }

    h1 {
      text-align: center;
      margin: 0 0 2rem 0;
      font-weight: 600;
      font-size: 2rem;
      color: #333
    }

    h2 {
      text-align: center;
      margin: 2rem 0 1rem 0;
      font-weight: 600;
      font-size: 1.5rem;
      color: #555
    }

    .chart {
      width: 100%;
      max-width: 960px;
      height: 400px;
      margin: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666
    }
  </style>
</head>

<body>
  <h1>Pathoplexus Organism Submissions Dashboard</h1>
  <div class="loading" id="loading">Loading data for all organisms...</div>
  <div id="charts-container"></div>
  <script>
    /**
     * Configuration for all Pathoplexus organisms
     */
    const organisms = [
      {
        name: "Crimean-Congo Hemorrhagic Fever Virus",
        endpoint: "cchf"
      },
      {
        name: "Ebola Sudan",
        endpoint: "ebola-sudan"
      },
      {
        name: "Ebola Zaire",
        endpoint: "ebola-zaire"
      },
      {
        name: "HMPV",
        endpoint: "hmpv"
      },
      {
        name: "Mpox Virus",
        endpoint: "mpox"
      },
      {
        name: "RSV-A",
        endpoint: "rsv-a"
      },
      {
        name: "RSV-B",
        endpoint: "rsv-b"
      },
      {
        name: "West Nile Virus",
        endpoint: "west-nile"
      }
    ];

    // ISO cut‑offs for the period of interest
    const PERIOD_START = new Date("2024-08-01T00:00:00Z");
    const PERIOD_END = new Date("2025-06-30T23:59:59Z");

    /**
     * Increment helper (avoids ternary ++ syntax error)
     */
    function incrementBucket(countObj, key, bucket) {
      countObj[key][bucket] += 1;
    }

    /**
     * Create a chart for a single organism
     */
    function createOrganismChart(organism, index) {
      const url = `https://lapis.pathoplexus.org/${organism.endpoint}/sample/details?dataFormat=tsv&fields=accessionVersion%2CearliestReleaseDate%2CgroupId&versionStatus=LATEST_VERSION&isRevocation=false`;

      const chartId = `chart-${index}`;

      // Create container for this organism
      const container = document.createElement('div');
      container.innerHTML = `
        <h2>${organism.name} genome submissions (monthly, 2024‑08 – 2025‑06)</h2>
        <div class="chart" id="${chartId}"></div>
      `;

      document.getElementById('charts-container').appendChild(container);

      // Fetch and plot data
      d3.tsv(url).then(rows => {

        const months = d3.timeMonth
          .range(PERIOD_START, d3.timeMonth.offset(PERIOD_END, 1))
          .map(d => d.toISOString().slice(0, 7));

        const counts = Object.fromEntries(
          months.map(m => [m, { insdc: 0, pathoplexus: 0 }])
        );

        // add real counts
        rows.forEach(r => {
          const d = new Date(r.earliestReleaseDate);
          if (isNaN(d) || d < PERIOD_START || d > PERIOD_END) return;
          const ym = d.toISOString().slice(0, 7);            // YYYY-MM
          const bucket = (+r.groupId === 1 ? "insdc" : "pathoplexus");
          if (counts[ym]) counts[ym][bucket] += 1;
        });

        const insdc = months.map(m => counts[m].insdc);
        const pathoplexus = months.map(m => counts[m].pathoplexus);

        const traces = [
          { x: months, y: insdc, name: "INSDC", mode: "lines+markers", line: { width: 2, color: '#3b82f6' } },
          { x: months, y: pathoplexus, name: "Pathoplexus direct", mode: "lines+markers", line: { width: 2, color: '#10b981' } }
        ];

        const layout = {
          margin: { t: 20, r: 10, l: 50, b: 50 },
          xaxis: { title: "Month", type: "category" },               // ensure categorical axis
          yaxis: { title: "Submissions" },
          legend: { orientation: "h", y: -0.25 },
          font: { size: 12 }
        };

        Plotly.newPlot(chartId, traces, layout, { responsive: true });
      }).catch(err => {
        console.error(`Data fetch or rendering error for ${organism.name}:`, err);
        document.getElementById(chartId).innerHTML = `<div style="text-align:center;padding:2rem;color:#ef4444">Failed to load data for ${organism.name}</div>`;
      });
    }

    /**
     * Initialize all charts
     */
    function initializeCharts() {
      organisms.forEach((organism, index) => {
        createOrganismChart(organism, index);
      });

      // Hide loading indicator
      document.getElementById('loading').style.display = 'none';
    }

    // Start loading charts when page is ready
    document.addEventListener('DOMContentLoaded', initializeCharts);
  </script>
</body>

</html>